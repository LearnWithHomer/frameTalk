(function(n){"use strict";function w(n,t){return Math.floor(Math.random()*(t-n+1))+n}function t(n){console.log("frameTalk ["+f+"("+e+")] says: "+n)}function r(n){u.debuging&&(console.log("frameTalk debug ["+f+"("+e+")] says: "),console.log(n))}function s(n){return n.postMessage?n:n.contentWindow&&n.contentWindow.postMessage?n.contentWindow:null}function l(){var n=i.length,t=new $.Deferred;return i[n]=t,n}function a(t){var i=n.document.getElementById(t);return i&&i.contentWindow?i:(i=n.parent.document.getElementById(t),i&&i.contentWindow?i:(i=n.document.getElementsByName(t)[0],i&&i.contentWindow?i:(i=n.parent.document.getElementsByName(t)[0],i&&i.contentWindow?i:null)))}function b(i,e){if(i=s(i),!i){t("handshakeFallback needs a window object with postMessage defined");return}n.top===n?(r("starting handshakeFallback from top window"),f="@@top@@"):(r("starting handshakeFallback from iframe: "+e),f=e);u.sendMessage(i,"handshake",[f])}function k(n,t,i){r("sending handshake, promise index: "+i);u.sendMessage(n,"handshake",[t],i)}function h(n,t){typeof i[n]=="object"&&(clearInterval(o[n]),i[n].reject(t),i[n]="rejected",o[n]="cleared")}function v(event){function returnPromise(i,r,f){r==="@@top@@"?(wObj=n.top,u.sendMessage(wObj,i,[f],promiseInd)):(wObj=a(r),wObj?u.sendMessage(wObj.contentWindow,i,[f],promiseInd):t("could not find handshake receiver"))}var eventObjData=n.JSON.retrocycle(JSON.parse(event.data)),theFunction=eventObjData.theFunction,theParams=eventObjData.theParams,windowId=eventObjData.windowId,promiseInd=eventObjData.promiseInd,frameIdToReply=eventObjData.fromId,wObj,fn;if(r("msg received, parsed:"),r(eventObjData),!theFunction){r("parameter 'theFunction' not found in postMessage. May not came via frameTalk. Aborted");return}if(windowId==e){t("msg rejected as echo");return}theFunction=="handshake"?(frameIdToReply=theParams[0],frameIdToReply||t("handshake needs iFrame id as second parameter in order to complete reply"),frameIdToReply==="@@top@@"?(wObj=n.top,u.sendMessage(wObj,"replyHandshake",[0],promiseInd)):(wObj=a(frameIdToReply),wObj?u.sendMessage(wObj.contentWindow,"replyHandshake",[1],promiseInd):t("could not find handshake receiver"))):theFunction=="replyHandshake"?promiseInd?(r("got handshake reply, promise index: "+promiseInd),i[promiseInd].resolve(!0),i[promiseInd]="success",clearInterval(o[promiseInd]),o[promiseInd]="cleared"):(r("got handshake reply with no promise index"),theParams[0]===0?t("HandShake with top window completed."):t("HandShake completed.")):theFunction=="replyPromiseOk"?(r("promise resolved, index: "+promiseInd),i[promiseInd].resolve(theParams),i[promiseInd]="success"):theFunction=="replyPromiseFail"?(r("promise rejected, index: "+promiseInd),i[promiseInd].reject(theParams),i[promiseInd]="fail"):promiseInd?(r("promise request received, index: "+promiseInd),fn=eval("window."+theFunction),typeof fn=="function"?fn.apply(this,theParams).then(function(n){returnPromise("replyPromiseOk",frameIdToReply,n)},function(n){returnPromise("replyPromiseFail",frameIdToReply,n)}):t("receiveMessage: function not found")):(fn=n[theFunction],typeof fn=="function"?fn.apply(this,theParams):t("receiveMessage: function not found"))}var u,c=!1,f,e=w(1e3,9999),y=!0,i=[0],o=[0],p=500;typeof JSON.decycle!="function"&&(JSON.decycle=function(n){var t=[],i=[];return function r(n,u){var f,e,o;if(typeof n=="object"&&n!==null&&!(n instanceof Boolean)&&!(n instanceof Date)&&!(n instanceof Number)&&!(n instanceof RegExp)&&!(n instanceof String)){for(f=0;f<t.length;f+=1)if(t[f]===n)return{$ref:i[f]};if(t.push(n),i.push(u),Object.prototype.toString.apply(n)==="[object Array]")for(o=[],f=0;f<n.length;f+=1)o[f]=r(n[f],u+"["+f+"]");else{o={};for(e in n)Object.prototype.hasOwnProperty.call(n,e)&&(o[e]=r(n[e],u+"["+JSON.stringify(e)+"]"))}return o}return n}(n,"$")});typeof JSON.retrocycle!="function"&&(JSON.retrocycle=function(n){var t=/^\$(?:\[(?:\d+|\"(?:[^\\\"\u0000-\u001f]|\\([\\\"\/bfnrt]|u[0-9a-zA-Z]{4}))*\")\])*$/;return function i(value){var i,item,name,path;if(value&&typeof value=="object")if(Object.prototype.toString.apply(value)==="[object Array]")for(i=0;i<value.length;i+=1)item=value[i],item&&typeof item=="object"&&(path=item.$ref,typeof path=="string"&&t.test(path)?value[i]=eval(path):i(item));else for(name in value)typeof value[name]=="object"&&(item=value[name],item&&(path=item.$ref,typeof path=="string"&&t.test(path)?value[name]=eval(path):i(item)))}(n),n});u={getId:function(){return e},debuging:!1,failTimeLimit:5e3,init:function(){return(n.JSON&&n.JSON.parse&&n.JSON.stringify)?(c?t("already init"):n.addEventListener?(n.addEventListener("message",v,!1),c=!0,n.frameTalkReady=!0):n.attachEvent?(n.attachEvent("onmessage",v),c=!0,n.frameTalkReady=!0):t("could not attach event listener"),t("init ready, window unique Id: "+e),!0):(t("No init, JSON missing, please load JSON2"),!1)},sendMessage:function(i,r,u,f){try{if(typeof r!="string"){t("sendMessage second param must be a function's name (string)");return}if(typeof u!="object"&&(u=[u]),i=s(i),!i){t("sendMessage first param must be a window object with postMessage defined.");return}var o={theFunction:r,theParams:u,windowId:e,promiseInd:f},h=n.JSON.stringify(JSON.decycle(o));i.postMessage(h,"*")}catch(c){t("sendMessage error: "+c.message)}},sendPromise:function(t,u,f,o){var c=l(u),a,v,y;return typeof f!="string"?(a="sendPromise second param must be a function's name (string)",r(a),setTimeout(function(){h(c,a)},500),i[c].promise()):(typeof o!="object"&&(o=[o]),t=s(t),!t)?(a="sendMessage first param must be a window object with postMessage defined.",r(a),setTimeout(function(){h(c,a)},500),i[c].promise()):(v={theFunction:f,theParams:o,windowId:e,promiseInd:c,fromId:u},y=n.JSON.stringify(v),t.postMessage(y,"*"),i[c].promise())},handshake:function(t,e){var c=l(),a;return(t=s(t),!t)?(a="handshake needs a window object with postMessage defined",setTimeout(function(){h(c,a)},500),i[c].promise()):(n.top===n?(r("starting handshake from top window"),f="@@top@@"):(r("starting handshake from iframe: "+e),f=e),o[c]=setInterval(function(){k(t,f,c)},p),a="handshake timeout. You can change timeout on frameTalk.failTimeLimit",setTimeout(function(){h(c,a)},u.failTimeLimit),i[c].promise())}};typeof n.jQuery!="function"&&(y=!1,u.handshake=b,t("caution, since no jQuery found, handshake functionality will not include promises"));u.init();n.frameTalk=u})(window);